<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>KQèŠå¤©å®¤</title>
	<style>
		/* Wordé£æ ¼ä¸»è‰²è°ƒ */
		:root {
			--word-blue: #2B579A;
			--word-light-blue: #E5ECF6;
			--word-gray: #F5F5F5;
			--word-dark-gray: #E0E0E0;
			--word-text: #333333;
			--word-border: 1px solid #D9D9D9;
		}

		body {
			font-family: 'Segoe UI', Arial, sans-serif;
			margin: 0;
			padding: 0;
			height: 100vh;
			display: flex;
			color: var(--word-text);
		}

		/* å·¦ä¾§åŠŸèƒ½åŒº - ç±»ä¼¼Wordèœå•æ  */
		.menu-bar {
			width: 60px;
			background-color: var(--word-blue);
			display: flex;
			flex-direction: column;
			align-items: center;
			padding-top: 20px;
		}

		.menu-item {
			color: white;
			padding: 12px 0;
			text-align: center;
			width: 100%;
			cursor: pointer;
		}

		.menu-item:hover {
			background-color: rgba(255, 255, 255, 0.2);
		}

		/* å³ä¾§è¾¹æ  - ç”¨æˆ·åˆ—è¡¨ */
		.sidebar {
			width: 260px; /* åŠ å®½ä»¥é€‚åº”æ›´å¤šä¿¡æ¯ */
			background-color: var(--word-gray);
			border-right: var(--word-border);
			display: flex;
			flex-direction: column;
		}

		.sidebar-header {
			padding: 12px 16px;
			background-color: var(--word-light-blue);
			border-bottom: var(--word-border);
			font-weight: 600;
		}

		.user-list {
			flex: 1;
			overflow-y: auto;
			padding: 0;
			margin: 0;
			list-style: none;
		}

		.user-item {
			padding: 12px 16px;
			border-bottom: var(--word-border);
			display: flex;
			align-items: center;
			cursor: pointer;
		}

		.user-item:hover {
			background-color: rgba(43, 87, 154, 0.05);
		}

		.user-avatar {
			width: 40px;
			height: 40px;
			background-color: var(--word-blue);
			color: white;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			margin-right: 12px;
			font-size: 16px;
			flex-shrink: 0;
		}

		.user-info {
			flex: 1;
			min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
		}

		.user-name {
			font-weight: 500;
			margin-bottom: 4px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.user-active-time {
			font-size: 12px;
			color: #666;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.current-user {
			background-color: var(--word-light-blue);
		}

		/* ä¸»èŠå¤©åŒºåŸŸ */
		.main-content {
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		.chat-header {
			padding: 12px 20px;
			background-color: var(--word-light-blue);
			border-bottom: var(--word-border);
			display: flex;
			align-items: center;
		}

		.chat-title {
			margin: 0;
			flex: 1;
		}

		.chat-status {
			font-size: 14px;
			color: #666;
		}

		.chat-messages {
			flex: 1;
			overflow-y: auto;
			padding: 20px;
			background-color: white;
		}

		.message {
			margin-bottom: 16px;
			max-width: 70%;
		}

		.message.received {
			margin-right: auto;
		}

		.message.sent {
			margin-left: auto;
		}

		.message-content {
			padding: 10px 15px;
			border-radius: 4px;
			background-color: var(--word-gray);
			border: var(--word-border);
			word-break: break-word;
			line-height: 1.5;
		}

		.message.sent .message-content {
			background-color: var(--word-blue);
			color: white;
			border-color: var(--word-blue);
		}

		.message-info {
			font-size: 12px;
			color: #666;
			margin-bottom: 4px;
			display: flex;
			align-items: center;
		}

		.message-sender {
			font-weight: 500;
			margin-right: 8px;
		}

		.message-time {
			opacity: 0.8;
		}

		/* è¾“å…¥åŒºåŸŸ */
		.input-area {
			padding: 12px 20px;
			background-color: var(--word-gray);
			border-top: var(--word-border);
			display: flex;
		}

		.message-input {
			flex: 1;
			padding: 10px 12px;
			border: var(--word-border);
			border-radius: 4px;
			outline: none;
			font-size: 14px;
		}

		.message-input:focus {
			border-color: var(--word-blue);
		}

		.send-button {
			background-color: var(--word-blue);
			color: white;
			border: none;
			border-radius: 4px;
			padding: 0 20px;
			margin-left: 10px;
			cursor: pointer;
			font-size: 14px;
		}

		/* æ»šåŠ¨æ¡æ ·å¼ */
		::-webkit-scrollbar {
			width: 6px;
			height: 6px;
		}

		::-webkit-scrollbar-thumb {
			background-color: rgba(0, 0, 0, 0.2);
			border-radius: 3px;
		}

		::-webkit-scrollbar-track {
			background-color: transparent;
		}



		/* æ¶ˆæ¯å®¹å™¨æ ·å¼è°ƒæ•´ */
		.message {
			display: flex;
			align-items: flex-start;
			margin-bottom: 16px;
			max-width: 70%;
			gap: 10px; /* æ·»åŠ é—´è· */
		}

		.message.received {
			margin-right: auto;
			flex-direction: row; /* æ¥æ”¶æ¶ˆæ¯ä»å·¦åˆ°å³æ’åˆ— */
		}

		.message.sent {
			margin-left: auto;
			flex-direction: row-reverse; /* å‘é€æ¶ˆæ¯ä»å³åˆ°å·¦æ’åˆ— */
		}

		/* å¤´åƒæ ·å¼è°ƒæ•´ */
		.user-avatar {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			object-fit: cover;
			flex-shrink: 0; /* é˜²æ­¢å¤´åƒè¢«å‹ç¼© */
		}

		/* æ¶ˆæ¯å†…å®¹å®¹å™¨ */
		.message-content-container {
			display: flex;
			flex-direction: column;
			max-width: calc(100% - 50px); /* å‡å»å¤´åƒå®½åº¦å’Œé—´è· */
		}

		/* æ¶ˆæ¯ä¿¡æ¯è¡Œ */
		.message-info {
			display: flex;
			align-items: center;
			margin-bottom: 4px;
			font-size: 12px;
			color: #666;
		}

		/* æ¶ˆæ¯å†…å®¹æ ·å¼ */
		.message-content {
			padding: 10px 15px;
			border-radius: 4px;
			word-break: break-word;
			line-height: 1.5;
			max-width: 100%;
		}

		.message.received .message-content {
			background-color: var(--word-gray);
			border: var(--word-border);
		}

		.message.sent .message-content {
			background-color: var(--word-blue);
			color: white;
			border: 1px solid var(--word-blue);
		}

		/* ç¾¤å…¬å‘Šæ ·å¼ */
		.chat-header {
			padding: 12px 20px;
			background-color: var(--word-light-blue);
			border-bottom: var(--word-border);
			display: flex;
			flex-direction: column;
		}

		.chat-title-container {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.announcement-toggle {
			background: none;
			border: none;
			color: var(--word-blue);
			cursor: pointer;
			font-size: 14px;
			padding: 4px 8px;
			outline: none;
			border-radius: 4px;
			transition: all 0.2s;
		}

		.announcement-toggle:hover {
			background-color: rgba(43, 87, 154, 0.1);
			text-decoration: none;
		}

		.announcement-content {
			max-height: 0;
			overflow: hidden;
			transition: max-height 0.3s ease-out;
			background-color: var(--word-light-blue);
			margin-top: 8px;
			border-radius: 4px;
		}

		.announcement-content.show {
			max-height: 500px;
			padding: 10px;
			border: var(--word-border);
		}

		.announcement-text {
			font-size: 14px;
			line-height: 1.6;
			color: var(--word-text);
		}



		/* è¾“å…¥å®¹å™¨æ ·å¼ */
		.input-container {
			flex: 1;
			display: flex;
			position: relative;
		}

		/* è¡¨æƒ…æŒ‰é’®æ ·å¼ */
		.emoji-button {
			background: none;
			border: none;
			font-size: 20px;
			padding: 0 10px;
			cursor: pointer;
			outline: none;
			background-color: white;
			border: var(--word-border);
			border-right: none;
			border-radius: 4px 0 0 4px;
		}

		.emoji-button:hover {
			background-color: var(--word-light-blue);
		}

		/* è°ƒæ•´è¾“å…¥æ¡†æ ·å¼ä»¥é…åˆè¡¨æƒ…æŒ‰é’® */
		.message-input {
			border-radius: 0 4px 4px 0;
			flex: 1;
		}

		/* è¡¨æƒ…é€‰æ‹©å™¨å®¹å™¨æ ·å¼ */
		#emoji-picker-container {
			position: absolute;
			bottom: 50px;
			left: 0;
			z-index: 1000;
			background: white;
			border: var(--word-border);
			border-radius: 4px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		}

		/* è¡¨æƒ…é€‰æ‹©å™¨è‡ªå®šä¹‰æ ·å¼ */
		#emoji-picker-container emoji-picker {
			--background: white;
			--border-color: var(--word-dark-gray);
			--input-border-color: var(--word-blue);
			--indicator-color: var(--word-blue);
			--num-columns: 8;
			--emoji-size: 1.5rem;
		}
	</style>

	<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>
	<script src="assets/vendor/jquery/jquery-3.5.1.min.js" type="text/javascript"></script>
	<script src="assets/js/sockjs.min.js"></script>
	<script src="assets/js/stomp.min.js"></script>
	<script src="assets/js/common.js"></script>
</head>
<body>
<!-- å·¦ä¾§èœå•æ  -->
<div class="menu-bar">
	<div class="menu-item">ğŸ’¬</div>
	<div class="menu-item">ğŸ‘¥</div>
	<div class="menu-item">âš™ï¸</div>
</div>

<!-- å³ä¾§è¾¹æ  - ç”¨æˆ·åˆ—è¡¨ -->
<div class="sidebar">
	<div class="sidebar-header"></div>
	<ul class="user-list" id="user-list">
<!--		åŠ¨æ€å¡«å……-->
<!--		<li class="user-item current-user">-->
<!--			<div class="user-avatar"></div>-->
<!--			<div class="user-info">-->
<!--				<div class="user-name">æå›› (æˆ‘)</div>-->
<!--				<div class="user-active-time">åœ¨çº¿</div>-->
<!--			</div>-->
<!--		</li>-->
<!--		<li class="user-item">-->
<!--			<div class="user-avatar"></div>-->
<!--			<div class="user-info">-->
<!--				<div class="user-name">ç‹äº”</div>-->
<!--				<div class="user-active-time">5åˆ†é’Ÿå‰</div>-->
<!--			</div>-->
<!--		</li>-->
	</ul>
</div>

<!-- ä¸»èŠå¤©åŒºåŸŸ -->
<div class="main-content">
	<!-- ä¿®æ”¹chat-headeréƒ¨åˆ† -->
	<div class="chat-header">
		<div class="chat-title-container">
			<h3 class="chat-title">è®©æˆ‘ä»¬è¡èµ·åŒæ¡¨~</h3>
			<button class="announcement-toggle">ç¾¤å…¬å‘Š â–¼</button>
		</div>
		<div class="announcement-content">
			<div class="announcement-text">
				æ¬¢è¿åŠ å…¥KQèŠå¤©å®¤ï¼<br><br>
				1. è¯é¢˜ä¸è¦ç‰µæ¶‰æ”¿æ²»ã€ä¸è¦ç‰µæ¶‰æ”¿æ²»ã€ä¸è¦ç‰µæ¶‰æ”¿æ²»ï¼›<br>
				2. èŠå¤©æ•°æ®ä¸åšæŒä¹…åŒ–ï¼Œåªä¿å­˜äºrediså†…å­˜æ•°æ®åº“ï¼Œå¹¶ä¸”æœ€å¤šä¿ç•™24å°æ—¶ï¼›<br>
				3. å…è´£ç”³æ˜ï¼šæœ¬èŠå¤©å®¤ä¸æ˜¯å•†ç”¨è½¯ä»¶ï¼Œåªæ˜¯æœ¬äººç ”ç©¶æŠ€æœ¯çš„ä¸€ä¸ªdemoï¼Œä½ ä»¬éƒ½ç®—æ˜¯æµ‹è¯•äººå‘˜ï¼Œæµ‹è¯•ç»“æŸåæœ¬äººä¼šå…³é—­èŠå¤©å®¤ï¼›<br>
				4. å¯¹èŠå¤©å®¤æœ‰æ”¹è¿›å»ºè®®çš„è¯·ç•™è¨€ï¼
			</div>
		</div>
	</div>

	<div class="chat-messages">
	<!--		åŠ¨æ€å¡«å……-->
	</div>

	<!-- è¾“å…¥åŒºåŸŸ -->
	<div class="input-area">
		<div class="input-container">
			<button id="emoji-button" class="emoji-button">ğŸ˜Š</button>
			<input type="text" class="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
		</div>
		<button class="send-button">å‘é€</button>
		<div id="emoji-picker-container" style="display: none;"></div>
	</div>
</div>

<script>
	//æ ¡éªŒtokenæ˜¯å¦æœ‰æ•ˆ
	$(document).ready(function () {
		const token = sessionStorage.getItem('token');
		if (!token) {
			// å¦‚æœç”¨æˆ·åä¸ºç©ºï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
			window.location.href = "/login.html";
		}

		// åˆ›å»º FormData å¯¹è±¡
		const formData = new FormData();
		formData.append("token", token);

		$.ajax({
			url: "/checkToken", // åç«¯æ¥å£åœ°å€
			method: "POST",
			data: formData,
			processData: false, // å‘Šè¯‰ jQuery ä¸è¦å»å¤„ç†å‘é€çš„æ•°æ®
			contentType: false, // å‘Šè¯‰ jQuery ä¸è¦å»è®¾ç½® Content-Type è¯·æ±‚å¤´
			success: function (data) {
				console.log(data.data);

			},
			error: function (xhr, status, error) {
				const response = JSON.parse(xhr.responseText);
				alert(response.msg); //tokenè¿‡æœŸ
				// æ¸…é™¤ sessionStorage ä¸­çš„æ‰€æœ‰é¡¹
				window.location.href = "/login.html";
				sessionStorage.clear();
			}
		});
	});
</script>

<script>
	$(document).ready(function () {
		// è¡¨æƒ…é€‰æ‹©å™¨åŠŸèƒ½
		const emojiButton = $('#emoji-button');
		const emojiPickerContainer = $('#emoji-picker-container');

		// åˆ›å»ºè¡¨æƒ…é€‰æ‹©å™¨
		const picker = document.createElement('emoji-picker');
		picker.addEventListener('emoji-click', event => {
			const input = $('.message-input');
			input.val(input.val() + event.detail.unicode);
			emojiPickerContainer.hide();
		});
		document.getElementById('emoji-picker-container').appendChild(picker);

		// åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨æ˜¾ç¤º/éšè—
		emojiButton.click(function (e) {
			e.stopPropagation();
			emojiPickerContainer.toggle();
		});

		// ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸéšè—è¡¨æƒ…é€‰æ‹©å™¨
		$(document).click(function () {
			emojiPickerContainer.hide();
		});

		// é˜»æ­¢è¡¨æƒ…é€‰æ‹©å™¨å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
		emojiPickerContainer.click(function (e) {
			e.stopPropagation();
		});
	});
</script>

<script>
	refreshUserList();
</script>

<script>
	$(document).ready(function () {
		// è·å–ç¾¤èŠåˆ—è¡¨çš„å®¹å™¨
		const usernameInSession = sessionStorage.getItem('username');
		const chatMessages = $('.chat-messages'); // ä¿®æ”¹ä¸ºä½¿ç”¨æ­£ç¡®çš„å®¹å™¨

		// å‘èµ·è¯·æ±‚è·å–ç¾¤ç»„æ¶ˆæ¯
		$.ajax({
			url: "/groupMsg/",
			method: "GET",
			success: function (response) {
				console.log(response.data);
				const messages = response.data;

				// æ¸…ç©ºç°æœ‰æ¶ˆæ¯
				chatMessages.empty();

				// æ¸²æŸ“èŠå¤©æ¶ˆæ¯
				$.each(messages, function (index, message) {
					const isCurrentUser = usernameInSession === message.username;
					const messageClass = isCurrentUser ? 'sent' : 'received';

					const messageElement = $(`
        <div class="message ${messageClass}">
            <img class="user-avatar" src="${message.headpic || 'default-avatar.png'}"
                 alt="${message.username}"
                 onerror="this.src='default-avatar.png'">
            <div class="message-content-container">
                <div class="message-info">
                    <span class="message-sender">${message.username}${isCurrentUser ? ' (æˆ‘)' : ''}</span>
                    <span class="message-time">${message.sendTimeStr}</span>
                </div>
                <div class="message-content">
                    ${message.message}
                </div>
            </div>
        </div>
    `);

					chatMessages.append(messageElement);
				});

				// æ»šåŠ¨åˆ°åº•éƒ¨
				chatMessages.scrollTop(chatMessages[0].scrollHeight);
			},
			error: function (xhr, status, error) {
				console.error("è·å–ç¾¤ç»„æ¶ˆæ¯å‡ºé”™:", error);
				chatMessages.append('<div class="message received">æ— æ³•åŠ è½½æ¶ˆæ¯ï¼Œè¯·åˆ·æ–°é‡è¯•</div>');
			}
		});
	});
</script>

<script>
	$(document).ready(function () {
		const currentToken = sessionStorage.getItem('token');
		const usernameInSession = sessionStorage.getItem('username');
		const chatMessages = $('.chat-messages');

		// åˆ›å»ºä¸€ä¸ª SockJS å®¢æˆ·ç«¯å®ä¾‹
		const socket = new SockJS('/ws/chat');

		// ä½¿ç”¨ Stomp.js å°è£… SockJS
		const stompClient = Stomp.over(socket);

		// è¿æ¥ WebSocket æœåŠ¡å™¨
		stompClient.connect({}, function (frame) {
			console.log('Connected: ' + frame);

			// è®¢é˜… /topic/chatï¼Œæ¥æ”¶ç¾¤èŠæ¶ˆæ¯
			stompClient.subscribe('/topic/chat', function (content) {
				console.log('Received message:', content);
				if (content.body) {
					const message = JSON.parse(content.body);
					appendMessage(message);
					refreshUserList();
					// æ»šåŠ¨åˆ°åº•éƒ¨
					chatMessages.scrollTop(chatMessages[0].scrollHeight);
				}
			});

			// è·å–è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®
			const messageInput = $('.message-input');
			const sendButton = $('.send-button');

			// ç›‘å¬è¾“å…¥æ¡†çš„ keypress äº‹ä»¶
			messageInput.on('keypress', function (e) {
				// æ£€æµ‹æ˜¯å¦æŒ‰ä¸‹äº†å›è½¦é”®ï¼ˆé”®ç ä¸º 13ï¼‰
				if (e.which === 13) {
					// é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆé˜²æ­¢æ¢è¡Œï¼‰
					e.preventDefault();
					// è§¦å‘å‘é€
					sendMessage();
				}
			});

			// å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
			sendButton.click(sendMessage);

			function sendMessage() {
				const message = messageInput.val().trim();
				if (message) {
					console.log('Sending message:', message);
					stompClient.send("/app/send", {}, currentToken + "--%--" + message);
					messageInput.val(''); // æ¸…ç©ºè¾“å…¥æ¡†
				}
			}

			function appendMessage(message) {
				const isCurrentUser = usernameInSession === message.username;
				const messageClass = isCurrentUser ? 'sent' : 'received';

				const messageElement = $(`
                    <div class="message ${messageClass}">
                        <img class="user-avatar" src="${message.headpic || 'default-avatar.png'}"
                             alt="${message.username}"
                             onerror="this.src='default-avatar.png'">
                        <div class="message-content-container">
                            <div class="message-info">
                                <span class="message-sender">${message.username}${isCurrentUser ? ' (æˆ‘)' : ''}</span>
                                <span class="message-time">${message.sendTimeStr}</span>
                            </div>
                            <div class="message-content">
                                ${message.message}
                            </div>
                        </div>
                    </div>
                `);

				chatMessages.append(messageElement);
			}
		}, function (error) {
			// å¤„ç†è¿æ¥é”™è¯¯
			console.error('WebSocket connection error:', error);
		});

		stompClient.onerror = function (error) {
			console.error('STOMP error:', error);
		};
	});
</script>

<script>
	$(document).ready(function () {
		// å…¬å‘Šåˆ‡æ¢åŠŸèƒ½
		$('.announcement-toggle').click(function() {
			const content = $('.announcement-content');
			content.toggleClass('show');

			// åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
			if (content.hasClass('show')) {
				$(this).text('ç¾¤å…¬å‘Š â–²');
			} else {
				$(this).text('ç¾¤å…¬å‘Š â–¼');
			}
		});
	});
</script>
</body>
</html>
