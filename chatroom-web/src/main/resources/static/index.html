<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>KQ聊天室</title>
	<style>
		/* Word风格主色调 */
		:root {
			--word-blue: #2B579A;
			--word-light-blue: #E5ECF6;
			--word-gray: #F5F5F5;
			--word-dark-gray: #E0E0E0;
			--word-text: #333333;
			--word-border: 1px solid #D9D9D9;
		}

		body {
			font-family: 'Segoe UI', Arial, sans-serif;
			margin: 0;
			padding: 0;
			height: 100vh;
			display: flex;
			color: var(--word-text);
		}

		/* 左侧功能区 - 类似Word菜单栏 */
		.menu-bar {
			width: 60px;
			background-color: var(--word-blue);
			display: flex;
			flex-direction: column;
			align-items: center;
			padding-top: 20px;
		}

		.menu-item {
			color: white;
			padding: 12px 0;
			text-align: center;
			width: 100%;
			cursor: pointer;
		}

		.menu-item:hover {
			background-color: rgba(255, 255, 255, 0.2);
		}

		/* 右侧边栏 - 用户列表 */
		.sidebar {
			width: 260px; /* 加宽以适应更多信息 */
			background-color: var(--word-gray);
			border-right: var(--word-border);
			display: flex;
			flex-direction: column;
		}

		.sidebar-header {
			padding: 12px 16px;
			background-color: var(--word-light-blue);
			border-bottom: var(--word-border);
			font-weight: 600;
		}

		.user-list {
			flex: 1;
			overflow-y: auto;
			padding: 0;
			margin: 0;
			list-style: none;
		}

		.user-item {
			padding: 12px 16px;
			border-bottom: var(--word-border);
			display: flex;
			align-items: center;
			cursor: pointer;
		}

		.user-item:hover {
			background-color: rgba(43, 87, 154, 0.05);
		}

		.user-avatar {
			width: 40px;
			height: 40px;
			background-color: var(--word-blue);
			color: white;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			margin-right: 12px;
			font-size: 16px;
			flex-shrink: 0;
		}

		.user-info {
			flex: 1;
			min-width: 0; /* 防止内容溢出 */
		}

		.user-name {
			font-weight: 500;
			margin-bottom: 4px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.user-active-time {
			font-size: 12px;
			color: #666;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.current-user {
			background-color: var(--word-light-blue);
		}

		/* 主聊天区域 */
		.main-content {
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		.chat-header {
			padding: 12px 20px;
			background-color: var(--word-light-blue);
			border-bottom: var(--word-border);
			display: flex;
			align-items: center;
		}

		.chat-title {
			margin: 0;
			flex: 1;
		}

		.chat-status {
			font-size: 14px;
			color: #666;
		}

		.chat-messages {
			flex: 1;
			overflow-y: auto;
			padding: 20px;
			background-color: white;
		}

		.message {
			margin-bottom: 16px;
			max-width: 70%;
		}

		.message.received {
			margin-right: auto;
		}

		.message.sent {
			margin-left: auto;
		}

		.message-content {
			padding: 10px 15px;
			border-radius: 4px;
			background-color: var(--word-gray);
			border: var(--word-border);
			word-break: break-word;
			line-height: 1.5;
		}

		.message.sent .message-content {
			background-color: var(--word-blue);
			color: white;
			border-color: var(--word-blue);
		}

		.message-info {
			font-size: 12px;
			color: #666;
			margin-bottom: 4px;
			display: flex;
			align-items: center;
		}

		.message-sender {
			font-weight: 500;
			margin-right: 8px;
		}

		.message-time {
			opacity: 0.8;
		}

		/* 输入区域 */
		.input-area {
			padding: 12px 20px;
			background-color: var(--word-gray);
			border-top: var(--word-border);
			display: flex;
		}

		.message-input {
			flex: 1;
			padding: 10px 12px;
			border: var(--word-border);
			border-radius: 4px;
			outline: none;
			font-size: 14px;
		}

		.message-input:focus {
			border-color: var(--word-blue);
		}

		.send-button {
			background-color: var(--word-blue);
			color: white;
			border: none;
			border-radius: 4px;
			padding: 0 20px;
			margin-left: 10px;
			cursor: pointer;
			font-size: 14px;
		}

		/* 滚动条样式 */
		::-webkit-scrollbar {
			width: 6px;
			height: 6px;
		}

		::-webkit-scrollbar-thumb {
			background-color: rgba(0, 0, 0, 0.2);
			border-radius: 3px;
		}

		::-webkit-scrollbar-track {
			background-color: transparent;
		}
	</style>

	<script src="assets/vendor/jquery/jquery-3.5.1.min.js" type="text/javascript"></script>
	<script src="assets/js/sockjs.min.js"></script>
	<script src="assets/js/stomp.min.js"></script>
	<script src="assets/js/common.js"></script>
</head>
<body>
<!-- 左侧菜单栏 -->
<div class="menu-bar">
	<div class="menu-item">💬</div>
	<div class="menu-item">👥</div>
	<div class="menu-item">⚙️</div>
</div>

<!-- 右侧边栏 - 用户列表 -->
<div class="sidebar">
	<div class="sidebar-header"></div>
	<ul class="user-list" id="user-list">
<!--		<li class="user-item current-user">-->
<!--			<div class="user-avatar"></div>-->
<!--			<div class="user-info">-->
<!--				<div class="user-name">李四 (我)</div>-->
<!--				<div class="user-active-time">在线</div>-->
<!--			</div>-->
<!--		</li>-->
<!--		<li class="user-item">-->
<!--			<div class="user-avatar"></div>-->
<!--			<div class="user-info">-->
<!--				<div class="user-name">王五</div>-->
<!--				<div class="user-active-time">5分钟前</div>-->
<!--			</div>-->
<!--		</li>-->
	</ul>
</div>

<!-- 主聊天区域 -->
<div class="main-content">
	<div class="chat-header">
		<h3 class="chat-title">KQ聊天室</h3>
	</div>

	<div class="chat-messages">
		<!-- 收到的消息 -->
		<div class="message received">
			<div class="message-info">
				<span class="message-sender">张三</span>
				<span class="message-time">10:30</span>
			</div>
			<div class="message-content">
				大家好，欢迎使用Word风格聊天室！这个界面设计采用了Microsoft Word的标志性蓝色主题，保持了Office产品的专业感和简洁性。
			</div>
		</div>

		<!-- 发送的消息 -->
		<div class="message sent">
			<div class="message-info">
				<span class="message-sender">李四 (我)</span>
				<span class="message-time">10:32</span>
			</div>
			<div class="message-content">
				这个设计真不错！我喜欢右侧用户列表的布局，特别是显示了用户头像、昵称和最近活跃时间，非常实用。
			</div>
		</div>

		<div class="message received">
			<div class="message-info">
				<span class="message-sender">王五</span>
				<span class="message-time">10:33</span>
			</div>
			<div class="message-content">
				是的，界面很清晰。左侧的菜单栏、右侧的用户列表和中间的聊天区域分布合理，保持了Word的经典布局风格。
			</div>
		</div>

		<div class="message received">
			<div class="message-info">
				<span class="message-sender">张三</span>
				<span class="message-time">10:35</span>
			</div>
			<div class="message-content">
				用户列表现在显示了更多信息，包括头像、昵称和活跃时间，这样我们就能知道谁在线、谁最近活跃过。
			</div>
		</div>

		<div class="message sent">
			<div class="message-info">
				<span class="message-sender">李四 (我)</span>
				<span class="message-time">10:36</span>
			</div>
			<div class="message-content">
				而且当前用户有特殊高亮显示，非常直观。整体配色和细节处理都很专业！
			</div>
		</div>
	</div>

	<!-- 输入区域 -->
	<div class="input-area">
		<input type="text" class="message-input" placeholder="输入消息...">
		<button class="send-button">发送</button>
	</div>
</div>

<script>
	//校验token是否有效
	$(document).ready(function () {
		const token = sessionStorage.getItem('token');
		if (!token) {
			// 如果用户名为空，跳转到登录页面
			window.location.href = "/login.html";
		}

		// 创建 FormData 对象
		const formData = new FormData();
		formData.append("token", token);

		$.ajax({
			url: "/checkToken", // 后端接口地址
			method: "POST",
			data: formData,
			processData: false, // 告诉 jQuery 不要去处理发送的数据
			contentType: false, // 告诉 jQuery 不要去设置 Content-Type 请求头
			success: function (data) {
				console.log(data.data);

			},
			error: function (xhr, status, error) {
				const response = JSON.parse(xhr.responseText);
				alert(response.msg); //token过期
				// 清除 sessionStorage 中的所有项
				window.location.href = "/login.html";
				sessionStorage.clear();
			}
		});
	});
</script>

<script>
	refreshUserList();
</script>

<script>
	$(document).ready(function () {
		// 获取群聊列表的容器
		const usernameInSession = sessionStorage.getItem('username');
		const messageList = $('#message-list');
		// 发起请求获取用户列表
		$.ajax({
			url: "/groupMsg/", // 后端接口地址
			method: "GET",
			success: function (content) {
				console.log(content.data);
				content = content.data;

				// 渲染聊天列表
				$.each(content, function (index, messageV1) {
					if (usernameInSession == messageV1.username) {
						messageList.append("<li class=\"  d-flex message right   \">\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t<div class=\"mr-lg-3 me-2\">\n"
							+ "\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t<div class=\"message-body\">\n"
							+ "<img class=\"avatar sm rounded-circle b-orange\" src=\" " + messageV1.headpic
							+ "  \" alt=\"avatar\">"
							+ "\t\t\t\t\t\t\t\t<span class=\"date-time text-muted\">" + messageV1.username + ", "
							+ messageV1.sendTimeStr
							+ "</span>\n"
							+ "\t\t\t\t\t\t\t\t<div class=\"   message-row d-flex align-items-center justify-content-end   \">\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t\t<div class=\"message-content p-3\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t " + messageV1.message + "  \n"
							+ "\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t\t<div class=\"dropdown\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t<a class=\"text-muted ms-1 p-2 text-muted\" href=\"#\" data-toggle=\"dropdown\"\n"
							+ "\t\t\t\t\t\t\t\t\t\t   aria-haspopup=\"true\" aria-expanded=\"false\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t\t<i class=\"zmdi zmdi-more-vert\"></i>\n"
							+ "\t\t\t\t\t\t\t\t\t\t</a>\n"
							+ "\t\t\t\t\t\t\t\t\t\t<div class=\"dropdown-menu dropdown-menu-right\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t\t<a class=\"dropdown-item\" href=\"#\">删除</a>\n"
							+ "\t\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t</li>");
					} else {
						messageList.append("<li class=\"  d-flex message   \">\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t<div class=\"mr-lg-3 me-2\">\n"
							+ "<img class=\"avatar sm rounded-circle b-orange\" src=\" " + messageV1.headpic
							+ "  \" alt=\"avatar\">"
							+ "\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t<div class=\"message-body\">\n"
							+ "\t\t\t\t\t\t\t\t<span class=\"date-time text-muted\">" + messageV1.username + ", "
							+ messageV1.sendTimeStr
							+ "</span>\n"
							+ "\t\t\t\t\t\t\t\t<div class=\"   message-row d-flex align-items-center   \">\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t\t<div class=\"message-content p-3\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t " + messageV1.message + "  \n"
							+ "\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t\t<div class=\"dropdown\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t<div class=\"dropdown-menu dropdown-menu-right\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t</li>");
					}
				});
				$('.chat-content').scrollTop($('.chat-content')[0].scrollHeight);
			},
			error: function (xhr, status, error) {
				console.error("There was a problem with the fetch operation:", error);
			}
		});
	});
</script>

<script>
	$(document).ready(function () {
		const currentToken = sessionStorage.getItem('token');

		// 创建一个 SockJS 客户端实例
		const socket = new SockJS('/ws/chat');

		// 使用 Stomp.js 封装 SockJS
		const stompClient = Stomp.over(socket);

		// 连接 WebSocket 服务器
		stompClient.connect({}, function (frame) {
			console.log('Connected: ' + frame);

			// 订阅 /topic/chat，接收群聊消息
			stompClient.subscribe('/topic/chat', function (content) {
				console.log('content: ' + content);
				// 检查消息内容
				if (content.body) {
					console.log('Received message:', content.body);
					displayMessage(content.body);
					refreshUserList();
					$('.chat-content').scrollTop($('.chat-content')[0].scrollHeight);
				} else {
					console.error('No message body received');
				}
			});

			// 获取输入框和发送按钮
			const messageInput = $('#message');
			const sendButton = $('#sendButton');

			// 监听输入框的 keypress 事件
			messageInput.on('keypress', function (e) {
				// 检测是否按下了回车键（键码为 13）
				if (e.which === 13) {
					// 阻止默认行为（防止换行）
					e.preventDefault();
					// 触发发送按钮的点击事件
					sendButton.click();
				}
			});

			// 发送消息到服务器
			$('#sendButton').click(function () {
				var message = $('#message').val();
				if (message) {
					console.log('#sendButton message: ' + message);
					stompClient.send("/app/send", {}, currentToken + "--%--" + message);
					$('#message').val(''); // 清空输入框
				}
			});
		}, function (error) {
			// 处理连接错误
			console.error('WebSocket connection error:', error);
		});

		stompClient.onerror = function (error) {
			console.error('STOMP error:', error);
		};

		// 显示消息的函数
		function displayMessage(content) {
			content = JSON.parse(content);
			console.log('#displayMessage username: ' + content.username);
			const messageList = $('#message-list');
			const usernameInSession = sessionStorage.getItem('username');
			if (usernameInSession == content.username) {
				messageList.append("<li class=\"  d-flex message right   \">\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t<div class=\"mr-lg-3 me-2\">\n"
					+ "\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t<div class=\"message-body\">\n"
					+ "<img class=\"avatar sm rounded-circle b-orange\" src=\" " + content.headpic
					+ "  \" alt=\"avatar\">"
					+ "\t\t\t\t\t\t\t\t<span class=\"date-time text-muted\">" + content.username + ", "
					+ content.sendTimeStr
					+ "</span>\n"
					+ "\t\t\t\t\t\t\t\t<div class=\"   message-row d-flex align-items-center justify-content-end   \">\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t\t<div class=\"message-content p-3\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t " + content.message + "  \n"
					+ "\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t\t<div class=\"dropdown\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t<a class=\"text-muted ms-1 p-2 text-muted\" href=\"#\" data-toggle=\"dropdown\"\n"
					+ "\t\t\t\t\t\t\t\t\t\t   aria-haspopup=\"true\" aria-expanded=\"false\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t\t<i class=\"zmdi zmdi-more-vert\"></i>\n"
					+ "\t\t\t\t\t\t\t\t\t\t</a>\n"
					+ "\t\t\t\t\t\t\t\t\t\t<div class=\"dropdown-menu dropdown-menu-right\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t\t<a class=\"dropdown-item\" href=\"#\">删除</a>\n"
					+ "\t\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t</li>");
			} else {
				messageList.append("<li class=\"  d-flex message   \">\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t<div class=\"mr-lg-3 me-2\">\n"
					+ "<img class=\"avatar sm rounded-circle b-orange\" src=\" " + content.headpic
					+ "  \" alt=\"avatar\">"
					+ "\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t<div class=\"message-body\">\n"
					+ "\t\t\t\t\t\t\t\t<span class=\"date-time text-muted\">" + content.username + ", "
					+ content.sendTimeStr
					+ "</span>\n"
					+ "\t\t\t\t\t\t\t\t<div class=\"   message-row d-flex align-items-center   \">\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t\t<div class=\"message-content p-3\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t " + content.message + "  \n"
					+ "\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t\t<div class=\"dropdown\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t<div class=\"dropdown-menu dropdown-menu-right\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t</li>");
			}
		}
	});
</script>

<script>
	$(document).ready(function () {
		const container = $("#emoji-picker");
		let picker = null;

		$("#emoji-button").click(function (e) {
			e.stopPropagation(); // 防止事件冒泡导致立即隐藏

			if (container.is(":visible")) {
				container.hide();
			} else {
				container.show();

				// 如果 picker 不存在，则创建
				if (!picker) {
					picker = new EmojiMart.Picker({
						onEmojiSelect: (emoji) => {
							const input = $("#message");
							input.val(input.val() + emoji.native); // 插入 Emoji 到输入框
							container.hide();
						},
					});
					container.append(picker);
				}
			}
		});

		// 点击页面其他区域隐藏 Picker
		$(document).click(function () {
			container.hide();
		});

		// 阻止 Picker 内部点击事件冒泡
		container.click(function (e) {
			e.stopPropagation();
		});
	});
</script>
</body>
</html>
