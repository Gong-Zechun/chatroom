<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="Responsive Bootstrap 4 and web Application ui kit.">
	<title>聊天室</title>
	<link rel="icon" href="favicon.ico" type="image/x-icon"/>

	<link rel="stylesheet" href="assets/fonts/material-icon/css/material-design-iconic-font.min.css">
	<link rel="stylesheet" href="assets/vendor/bootstrap-datepicker/css/bootstrap-datepicker.min.css">

	<link rel="stylesheet" href="assets/css/style.min.css">
	<!-- 引入 Emoji Mart CSS -->
	<link rel="stylesheet" href="emoji-mart/emoji-mart.css"/>
	<script src="emoji-mart/browser.js"></script>
	<script src="assets/js/sockjs.min.js"></script>
	<script src="assets/js/stomp.min.js"></script>
	<style>
		.chat-content {
			overflow-y: auto; /* 添加垂直滚动条 */
			height: 400px; /* 设置最大高度 */
			padding: 1rem; /* 可选：添加一些内边距 */
		}
	</style>
</head>
<body>
<div id="layout" class="theme-cyan">

	<div class="navigation navbar justify-content-center py-xl-4 py-md-3 py-0 px-3">

		<a href="old/index.html" title="Postman" class="brand">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 46 46" fill="none">
				<g id="logo-icon-color">
					<path id="Vector"
								d="M26.4966 6.01307V2.00436L22.9746 0L19.5029 2.00436V6.01307L22.9746 8.01743L26.4966 6.01307Z"
								fill="#4539CF"/>
					<path id="Vector_2"
								d="M34.7989 10.8235V6.81477L31.3272 4.81042L27.8555 6.81477V10.8235L31.3272 12.8279L34.7989 10.8235Z"
								fill="#4539CF"/>
					<path id="Vector_3"
								d="M43 15.4837V11.4749L39.5283 9.47058L36.0063 11.4749V15.4837L39.5283 17.488L43 15.4837Z"
								fill="#4539CF"/>
					<path id="Vector_4"
								d="M43 25.0043V20.9956L39.5283 18.9913L36.0063 20.9956V25.0043L39.5283 27.0087L43 25.0043Z"
								fill="#4539CF"/>
					<path id="Vector_5"
								d="M33.9935 19.9935V16.9368L31.3269 15.4336L28.6602 16.9368V19.9935L31.3269 21.5469L33.9935 19.9935Z"
								fill="#4539CF"/>
					<path id="Vector_6"
								d="M33.9935 29.5142V26.4575L31.3269 24.9041L28.6602 26.4575V29.5142L31.3269 31.0174L33.9935 29.5142Z"
								fill="#4539CF"/>
					<path id="Vector_7"
								d="M15.931 19.6928V17.2876L13.8178 16.085L11.7549 17.2876V19.6928L13.8178 20.8453L15.931 19.6928Z"
								fill="#4539CF"/>
					<path id="Vector_8"
								d="M15.931 29.1634V26.7582L13.8178 25.5555L11.7549 26.7582V29.1634L13.8178 30.366L15.931 29.1634Z"
								fill="#4539CF"/>
					<path id="Vector_9"
								d="M6.4717 24.0022V21.9978L4.76101 20.9956L3 21.9978V24.0022L4.76101 25.0044L6.4717 24.0022Z"
								fill="#4539CF"/>
					<path id="Vector_10"
								d="M43 34.4749V30.4662L39.5283 28.4619L36.0063 30.4662V34.4749L39.5283 36.4793L43 34.4749Z"
								fill="#4539CF"/>
					<path id="Vector_11"
								d="M25.9433 15.1329V11.8758L23.1257 10.2222L20.2578 11.8758V15.1329L23.1257 16.7865L25.9433 15.1329Z"
								fill="#4539CF"/>
					<path id="Vector_12"
								d="M25.9433 34.1242V30.8671L23.1257 29.2135L20.2578 30.8671V34.1242L23.1257 35.7778L25.9433 34.1242Z"
								fill="#4539CF"/>
					<path id="Vector_13"
								d="M25.4908 24.3529V21.597L23.126 20.244L20.7109 21.597V24.3529L23.126 25.756L25.4908 24.3529Z"
								fill="#4539CF"/>
					<path id="Vector_14"
								d="M34.7989 39.1852V35.1765L31.3272 33.1721L27.8555 35.1765V39.1852L31.3272 41.1896L34.7989 39.1852Z"
								fill="#4539CF"/>
					<path id="Vector_15"
								d="M16.6856 10.2222V6.91507L13.8176 5.26147L10.9497 6.91507V10.2222L13.8176 11.8257L16.6856 10.2222Z"
								fill="#4539CF"/>
					<path id="Vector_16"
								d="M6.22013 12.9782V11.1242L4.61006 10.1721L3 11.1242V12.9782L4.61006 13.9303L6.22013 12.9782Z"
								fill="#4539CF"/>
					<path id="Vector_17"
								d="M26.4966 43.9956V39.9868L22.9746 37.9825L19.5029 39.9868V43.9956L22.9746 45.9999L26.4966 43.9956Z"
								fill="#4539CF"/>
					<path id="Vector_18"
								d="M16.6856 39.0849V35.7777L13.8176 34.1241L10.9497 35.7777V39.0849L13.8176 40.7385L16.6856 39.0849Z"
								fill="#4539CF"/>
					<path id="Vector_19"
								d="M7.5283 34.8257V32.22L5.26415 30.9172L3 32.22V34.8257L5.26415 36.1285L7.5283 34.8257Z"
								fill="#4539CF"/>
				</g>
			</svg>
		</a>

		<div class="nav flex-md-column nav-pills flex-grow-1" role="tablist" aria-orientation="vertical">
			<a class="mb-xl-3 mb-md-2 nav-link" data-toggle="pill" href="#nav-tab-user" role="tab">
				<img src="assets/images/user.png" class="avatar sm rounded-circle" alt="user avatar"/>
			</a>
			<a class="mb-xl-3 mb-md-2 nav-link active" data-toggle="pill" href="#nav-tab-chat" role="tab"><i
				class="zmdi zmdi-comment-alt"></i></a>
		</div>

		<div class="nav flex-md-column nav-pills flex-grow-2" role="tablist" aria-orientation="vertical">
			<a class="mt-xl-3 mt-md-2 nav-link light-dark-toggle" href="javascript:void(0);">
				<i class="zmdi zmdi-brightness-2"></i>
				<input class="light-dark-btn" type="checkbox">
			</a>
		</div>

		<button type="submit" class="btn sidebar-toggle-btn shadow-sm"><i class="zmdi zmdi-menu"></i></button>
	</div>


	<div class="sidebar border-end py-xl-4 py-3 px-xl-4 px-3">
		<div class="tab-content">


			<div class="tab-pane fade show active" id="nav-tab-chat" role="tabpanel">

				<div class="d-flex justify-content-between align-items-center mb-4">
					<h3 class="mb-0 text-primary">聊天室</h3>
				</div>

				<ul class="chat-list" id="user-list">
					<li class="header d-flex justify-content-between ps-3 pe-3 mb-1">
						<span id="users-total-num"></span> <!--这里的内容会动态填充-->
						<div class="dropdown">
							<a class="btn btn-link px-1 py-0 border-0 text-muted dropdown-toggle" href="#" role="button"
								 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i
								class="zmdi zmdi-filter-list"></i></a>
							<div class="dropdown-menu dropdown-menu-right">
								<a class="dropdown-item" href="#">Action</a>
								<a class="dropdown-item" href="#">Another action</a>
								<a class="dropdown-item" href="#">Something else here</a>
							</div>
						</div>
					</li>
				</ul>
			</div>
		</div>
	</div>


	<div class="rightbar d-none d-md-block">
		<div class="tab-content py-xl-4 py-3 px-xl-4 px-3">

			<div class="tab-pane fade" id="tab-calendar" role="tabpanel">
				<div class="header border-bottom pb-4 d-flex justify-content-between">
					<div>
						<h6 class="mb-0 font-weight-bold">Calendar</h6>
						<span class="text-muted">Update your profile details</span>
					</div>
					<div>
						<button class="btn btn-link close-sidebar text-muted" type="button"><i
							class="zmdi zmdi-close"></i></button>
					</div>
				</div>
				<div class="body mt-4">
					<div id="mini-calendar"></div>
				</div>
			</div>

			<div class="tab-pane fade" id="tab-note" role="tabpanel">
				<div class="header border-bottom pb-4 d-flex justify-content-between">
					<div>
						<h6 class="mb-0 font-weight-bold">My Notes</h6>
						<span class="text-muted">Update your profile details</span>
					</div>
					<div>
						<button class="btn btn-link close-sidebar text-muted" type="button"><i
							class="zmdi zmdi-close"></i></button>
					</div>
				</div>
			</div>

			<div class="tab-pane fade" id="tab-task" role="tabpanel">
				<div class="header border-bottom pb-4 d-flex justify-content-between">
					<div>
						<h6 class="mb-0 font-weight-bold">My Task List</h6>
						<span class="text-muted">Update your profile details</span>
					</div>
					<div>
						<button class="btn btn-link close-sidebar text-muted" type="button"><i
							class="zmdi zmdi-close"></i></button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="main px-xl-5 px-lg-4 px-3">

		<div class="chat-body">

			<div class="chat-header border-bottom py-xl-4 py-md-3 py-2">
				<div class="container-xxl">
					<div class="row align-items-center">

						<div class="col-6 col-xl-4" style="width:80%;">
							<div class="media">
								<div class="avatar me-3 show-user-detail" data-toggle="tooltip" title="Group details">
									<div class="avatar rounded-circle no-image timber">
										<span>KQ</span>
									</div>
								</div>
<!--								<div class="media-body overflow-hidden">-->
								<div class="media-body">
									<div class="d-flex align-items-center mb-1">
										<h6 class="text-truncate mb-0 me-auto">群公告</h6>
									</div>
									<div>
										1、话题不要牵涉政治、不要牵涉政治、不要牵涉政治；2、聊天数据不做持久化，只保存于redis内存数据库，并且最多保留24小时；</br>
										3、本聊天室不是商用软件，只是本人研究技术的一个demo，你们都算是测试人员，测试结束后本人会关闭聊天室；</br>
										4、“查询聊天记录”和“删除自己发言”功能，现在还没做上去，后面加；5、对聊天室有改进建议的可以去贴吧发帖或者留言；</br>
									</div>
								</div>
							</div>
						</div>

						<div class="col-6 col-xl-8 text-end">
							<ul class="nav justify-content-end">
								<li class="nav-item list-inline-item d-none d-md-block me-3">
									<a href="#" class="nav-link text-muted px-3" data-toggle="collapse"
										 data-target="#chat-search-div" aria-expanded="true" title="Search this chat">
										<i class="zmdi zmdi-search zmdi-hc-lg"></i>
									</a>
								</li>

								<li class="nav-item list-inline-item d-block d-sm-none px-3">
									<div class="dropdown">
										<a class="nav-link text-muted px-0" href="#" data-toggle="dropdown"
											 aria-haspopup="true" aria-expanded="false">
											<i class="zmdi zmdi-more-vert zmdi-hc-lg"></i>
										</a>
										<div class="dropdown-menu dropdown-menu-right">
											<a class="dropdown-item" href="#">Search chat</a>
											<a class="dropdown-item" href="#">Attache Image</a>
											<a class="dropdown-item" href="#">Video call</a>
											<a class="dropdown-item" href="#">Call</a>
											<a class="dropdown-item" href="#">Add New</a>
										</div>
									</div>
								</li>

							</ul>
						</div>
					</div>
				</div>
			</div>

			<div class="collapse" id="chat-search-div">
				<div class="container-xxl py-2">
					<div class="input-group">
						<input type="text" class="form-control" placeholder="查询聊天记录（暂不可用）">
						<div class="input-group-append">
							<span class="input-group-text text-muted">0 / 0</span>
						</div>
						<div class="input-group-append">
							<button type="button" class="btn btn-secondary">查询</button>
						</div>
					</div>
				</div>
			</div>

			<div class="chat-content">
				<div class="container-xxl">
					<ul class="list-unstyled py-4" id="message-list">
						<!--动态填充内容-->
					</ul>
				</div>
			</div>

			<div class="chat-footer border-top py-xl-4 py-lg-2 py-2">
				<div class="container-xxl">
					<div class="row">
						<div class="col-12">
							<div class="input-group align-items-center">

								<input type="text" class="form-control border-0 pl-0" id="message"
											 placeholder="开始你的表演...">

								<div class="input-group-append">
								<span class="input-group-text border-0">
								<button class="btn btn-sm btn-link text-muted" data-toggle="tooltip" title="表情"
												type="button" id="emoji-button">
									<i class="zmdi zmdi-mood font-22"></i></button>
								</span>
								</div>

								<div id="emoji-picker" style="display: none; position: absolute; z-index: 1000;"></div>


								<div class="input-group-append">
								<span class="input-group-text border-0 pr-0">
								<button type="submit" class="btn btn-primary">
								<span class="d-none d-md-inline-block me-2" id="sendButton">发送</span>
								<i class="zmdi zmdi-mail-send"></i>
								</button>
								</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script src="assets/vendor/jquery/jquery-3.5.1.min.js" type="text/javascript"></script>
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js" type="text/javascript"></script>

<script src="assets/vendor/bootstrap-datepicker/js/bootstrap-datepicker.min.js" type="text/javascript"></script>

<script src="assets/js/template.js" type="text/javascript"></script>

<script src="https://ajax.cloudflare.com/cdn-cgi/scripts/7089c43e/cloudflare-static/rocket-loader.min.js"
				data-cf-settings="67ae01ba4dd2a59f70ab9427-|49" defer=""></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js"
				data-cf-beacon='{"r":1,"version":"2021.2.0","rayId":"6203529a7c4f3684","si":10}'></script>

<script>
	//校验token是否有效
	$(document).ready(function () {
		const token = sessionStorage.getItem('token');
		if (!token) {
			// 如果用户名为空，跳转到登录页面
			window.location.href = "/login.html";
		}

		// 创建 FormData 对象
		const formData = new FormData();
		formData.append("token", token);

		$.ajax({
			url: "/checkToken", // 后端接口地址
			method: "POST",
			data: formData,
			processData: false, // 告诉 jQuery 不要去处理发送的数据
			contentType: false, // 告诉 jQuery 不要去设置 Content-Type 请求头
			success: function (data) {
				console.log(data.data);

			},
			error: function (xhr, status, error) {
				const response = JSON.parse(xhr.responseText);
				alert(response.msg); //token过期
				// 清除 sessionStorage 中的所有项
				window.location.href = "/login.html";
				sessionStorage.clear();
			}
		});
	});
</script>

<script>
	$(document).ready(function () {
		// 获取用户列表的容器
		const userList = $("#user-list");
		const currentUsername = sessionStorage.getItem('username');
		const token = sessionStorage.getItem('token');

		// 判断用户名是否为空
		if (!currentUsername) {
			// 如果用户名为空，跳转到登录页面
			window.location.href = "/login.html";
		}

		// 发起请求获取用户列表
		$.ajax({
			url: "/users?currentUsername=" + currentUsername, // 后端接口地址
			method: "GET",
			success: function (data) {
				console.log(data.data);
				console.log("currentUsername:" + currentUsername);
				$("#users-total-num").append("成员列表（" + data.data.length + "人）");

				// 渲染用户列表
				$.each(data.data, function (index, user) {
					const userItem = $("<li></li>").addClass("online");

					const hoverAction = $("<div></div>").addClass("hover_action");
					// 			hoverAction.html(`
					//   <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-eye"></i></button>
					//   <button type="button" class="btn btn-link text-warning"><i class="zmdi zmdi-star"></i></button>
					//   <button type="button" class="btn btn-link text-danger"><i class="zmdi zmdi-delete"></i></button>
					// `);
					userItem.append(hoverAction);

					const userCard = $("<a></a>").addClass("card");
					userCard.html(`
          <div class="card-body">
            <div class="media">
              <div class="avatar me-3">
                <span class="status rounded-circle"></span>
                <img class="avatar rounded-circle" src="${user.headpic}" alt="avatar">
              </div>
              <div class="media-body overflow-hidden">
                <div class="d-flex align-items-center mb-1">
                  <h6 class="text-truncate mb-0 me-auto">${user.username}</h6>
<!--                  <p class="small text-muted text-nowrap ms-4 mb-0">${user.lastMessageTime}</p>-->
                </div>
<!--                这个地方以后可以放个性签名-->
                      <div class="text-truncate">最近活跃：${user.lastVisitTimeStr}</div>
              </div>
            </div>
          </div>
        `);
					userItem.append(userCard);
					userList.append(userItem);
				});
			},
			error: function (xhr, status, error) {
				console.error("There was a problem with the fetch operation:", error);
			}
		});
	});
</script>

<script>
	$(document).ready(function () {
		// 获取群聊列表的容器
		const usernameInSession = sessionStorage.getItem('username');
		const messageList = $('#message-list');
		// 发起请求获取用户列表
		$.ajax({
			url: "/groupMsg/", // 后端接口地址
			method: "GET",
			success: function (content) {
				console.log(content.data);
				content = content.data;

				// 渲染聊天列表
				$.each(content, function (index, messageV1) {
					if (usernameInSession == messageV1.username) {
						messageList.append("<li class=\"  d-flex message right   \">\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t<div class=\"mr-lg-3 me-2\">\n"
							+ "\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t<div class=\"message-body\">\n"
							+ "<img class=\"avatar sm rounded-circle b-orange\" src=\" " + messageV1.headpic
							+ "  \" alt=\"avatar\">"
							+ "\t\t\t\t\t\t\t\t<span class=\"date-time text-muted\">" + messageV1.username + ", "
							+ messageV1.sendTimeStr
							+ "</span>\n"
							+ "\t\t\t\t\t\t\t\t<div class=\"   message-row d-flex align-items-center justify-content-end   \">\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t\t<div class=\"message-content p-3\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t " + messageV1.message + "  \n"
							+ "\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t\t<div class=\"dropdown\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t<a class=\"text-muted ms-1 p-2 text-muted\" href=\"#\" data-toggle=\"dropdown\"\n"
							+ "\t\t\t\t\t\t\t\t\t\t   aria-haspopup=\"true\" aria-expanded=\"false\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t\t<i class=\"zmdi zmdi-more-vert\"></i>\n"
							+ "\t\t\t\t\t\t\t\t\t\t</a>\n"
							+ "\t\t\t\t\t\t\t\t\t\t<div class=\"dropdown-menu dropdown-menu-right\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t\t<a class=\"dropdown-item\" href=\"#\">删除</a>\n"
							+ "\t\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t</li>");
					} else {
						messageList.append("<li class=\"  d-flex message   \">\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t<div class=\"mr-lg-3 me-2\">\n"
							+ "<img class=\"avatar sm rounded-circle b-orange\" src=\" " + messageV1.headpic
							+ "  \" alt=\"avatar\">"
							+ "\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t<div class=\"message-body\">\n"
							+ "\t\t\t\t\t\t\t\t<span class=\"date-time text-muted\">" + messageV1.username + ", "
							+ messageV1.sendTimeStr
							+ "</span>\n"
							+ "\t\t\t\t\t\t\t\t<div class=\"   message-row d-flex align-items-center   \">\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t\t<div class=\"message-content p-3\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t " + messageV1.message + "  \n"
							+ "\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t\t<div class=\"dropdown\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t<div class=\"dropdown-menu dropdown-menu-right\">\n"
							+ "\t\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t\t\t\t</div>\n"
							+ "\n"
							+ "\t\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t\t</div>\n"
							+ "\t\t\t\t\t\t</li>");
					}
				});
				$('.chat-content').scrollTop($('.chat-content')[0].scrollHeight);
			},
			error: function (xhr, status, error) {
				console.error("There was a problem with the fetch operation:", error);
			}
		});
	});
</script>

<script>
	$(document).ready(function () {
		const currentToken = sessionStorage.getItem('token');

		// 创建一个 SockJS 客户端实例
		const socket = new SockJS('/ws/chat');

		// 使用 Stomp.js 封装 SockJS
		const stompClient = Stomp.over(socket);

		// 连接 WebSocket 服务器
		stompClient.connect({}, function (frame) {
			console.log('Connected: ' + frame);

			// 订阅 /topic/chat，接收群聊消息
			stompClient.subscribe('/topic/chat', function (content) {
				console.log('content: ' + content);
				// 检查消息内容
				if (content.body) {
					console.log('Received message:', content.body);
					displayMessage(content.body);
					$('.chat-content').scrollTop($('.chat-content')[0].scrollHeight);
				} else {
					console.error('No message body received');
				}
			});

			// 获取输入框和发送按钮
			const messageInput = $('#message');
			const sendButton = $('#sendButton');

			// 监听输入框的 keypress 事件
			messageInput.on('keypress', function (e) {
				// 检测是否按下了回车键（键码为 13）
				if (e.which === 13) {
					// 阻止默认行为（防止换行）
					e.preventDefault();
					// 触发发送按钮的点击事件
					sendButton.click();
				}
			});

			// 发送消息到服务器
			$('#sendButton').click(function () {
				var message = $('#message').val();
				if (message) {
					console.log('#sendButton message: ' + message);
					stompClient.send("/app/send", {}, currentToken + "--%--" + message);
					$('#message').val(''); // 清空输入框
				}
			});
		}, function (error) {
			// 处理连接错误
			console.error('WebSocket connection error:', error);
		});

		stompClient.onerror = function (error) {
			console.error('STOMP error:', error);
		};

		// 显示消息的函数
		function displayMessage(content) {
			content = JSON.parse(content);
			console.log('#displayMessage username: ' + content.username);
			const messageList = $('#message-list');
			const usernameInSession = sessionStorage.getItem('username');
			if (usernameInSession == content.username) {
				messageList.append("<li class=\"  d-flex message right   \">\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t<div class=\"mr-lg-3 me-2\">\n"
					+ "\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t<div class=\"message-body\">\n"
					+ "<img class=\"avatar sm rounded-circle b-orange\" src=\" " + content.headpic
					+ "  \" alt=\"avatar\">"
					+ "\t\t\t\t\t\t\t\t<span class=\"date-time text-muted\">" + content.username + ", "
					+ content.sendTimeStr
					+ "</span>\n"
					+ "\t\t\t\t\t\t\t\t<div class=\"   message-row d-flex align-items-center justify-content-end   \">\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t\t<div class=\"message-content p-3\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t " + content.message + "  \n"
					+ "\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t\t<div class=\"dropdown\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t<a class=\"text-muted ms-1 p-2 text-muted\" href=\"#\" data-toggle=\"dropdown\"\n"
					+ "\t\t\t\t\t\t\t\t\t\t   aria-haspopup=\"true\" aria-expanded=\"false\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t\t<i class=\"zmdi zmdi-more-vert\"></i>\n"
					+ "\t\t\t\t\t\t\t\t\t\t</a>\n"
					+ "\t\t\t\t\t\t\t\t\t\t<div class=\"dropdown-menu dropdown-menu-right\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t\t<a class=\"dropdown-item\" href=\"#\">删除</a>\n"
					+ "\t\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t</li>");
			} else {
				messageList.append("<li class=\"  d-flex message   \">\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t<div class=\"mr-lg-3 me-2\">\n"
					+ "<img class=\"avatar sm rounded-circle b-orange\" src=\" " + content.headpic
					+ "  \" alt=\"avatar\">"
					+ "\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t<div class=\"message-body\">\n"
					+ "\t\t\t\t\t\t\t\t<span class=\"date-time text-muted\">" + content.username + ", "
					+ content.sendTimeStr
					+ "</span>\n"
					+ "\t\t\t\t\t\t\t\t<div class=\"   message-row d-flex align-items-center   \">\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t\t<div class=\"message-content p-3\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t " + content.message + "  \n"
					+ "\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t\t<div class=\"dropdown\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t<div class=\"dropdown-menu dropdown-menu-right\">\n"
					+ "\t\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t\t\t\t</div>\n"
					+ "\n"
					+ "\t\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t\t</div>\n"
					+ "\t\t\t\t\t\t</li>");
			}
		}
	});
</script>

<script>
	$(document).ready(function () {
		const container = $("#emoji-picker");
		let picker = null;

		$("#emoji-button").click(function (e) {
			e.stopPropagation(); // 防止事件冒泡导致立即隐藏

			if (container.is(":visible")) {
				container.hide();
			} else {
				container.show();

				// 如果 picker 不存在，则创建
				if (!picker) {
					picker = new EmojiMart.Picker({
						onEmojiSelect: (emoji) => {
							const input = $("#message");
							input.val(input.val() + emoji.native); // 插入 Emoji 到输入框
							container.hide();
						},
					});
					container.append(picker);
				}
			}
		});

		// 点击页面其他区域隐藏 Picker
		$(document).click(function () {
			container.hide();
		});

		// 阻止 Picker 内部点击事件冒泡
		container.click(function (e) {
			e.stopPropagation();
		});
	});
</script>

</body>
</html>
